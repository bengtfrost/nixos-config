# ‚ùÑÔ∏è Declarative NixOS with Flakes & Home Manager: A Zig Developer's Setup üöÄ

Welcome! This guide details how to set up a fully declarative, reproducible NixOS system using the power of Nix Flakes, manage your user environment with Home Manager, and compile a custom development version of the Zig programming language ‚ö°.

This configuration is based on **NixOS 25.05 "Warbler" (Stable)**.

**Benefits:**
*   ‚öôÔ∏è **Reproducibility:** Define your entire system as code and rebuild it precisely, anytime, anywhere.
*   üßπ **Clean Separation:** System configuration vs. user environment.
*   üì¶ **Controlled Dependencies:** Pin exact versions of your entire software stack.
*   ‚ú® **Declarative Power:** Describe *what* you want, let Nix figure out *how*.

---

## üìú Table of Contents

1.  [Part 1: Transitioning to a Full Flake-Managed NixOS System with Home Manager](#part-1-transitioning-to-a-full-flake-managed-nixos-system-with-home-manager)
    *   [1.1 Prerequisites & Initial Setup](#11-prerequisites--initial-setup)
    *   [1.2 Creating the System `flake.nix`](#12-creating-the-system-flakenix)
    *   [1.3 Refactoring `configuration.nix` as a Flake Module](#13-refactoring-configurationnix-as-a-flake-module)
    *   [1.4 Creating the User's Home Manager Configuration (`home.nix`)](#14-creating-the-users-home-manager-configuration-homenix)
    *   [1.5 The First System Build with Flakes & Home Manager](#15-the-first-system-build-with-flakes--home-manager)
2.  [Part 2: Customizing and Managing Your User Environment with Home Manager](#part-2-customizing-and-managing-your-user-environment-with-home-manager)
    *   [2.1 Adding and Removing User Packages (`home.packages`)](#21-adding-and-removing-user-packages-homepackages)
    *   [2.2 Advanced Shell Configuration (Zsh Example)](#22-advanced-shell-configuration-zsh-example)
    *   [2.3 Managing Application Settings (`programs.appname`)](#23-managing-application-settings-programsappname)
    *   [2.4 Managing Dotfiles (`home.file` or `xdg.configFile`)](#24-managing-dotfiles-homefile-or-xdgconfigfile)
3.  [Part 3: Building a Custom Zig Development Version ‚ö°](#part-3-building-a-custom-zig-development-version-)
    *   [3.1 Prerequisites](#31-prerequisites-1)
    *   [3.2 The Build Script (`build-zig-dev.sh`)](#32-the-build-script-build-zig-devsh)
    *   [3.3 Running the Build Script with `nix-shell`](#33-running-the-build-script-with-nix-shell)
    *   [3.4 Post-Build: Using Your Custom Zig](#34-post-build-using-your-custom-zig)
4.  [Part 4: System and Package Updates with Flakes üîÑ](#part-4-system-and-package-updates-with-flakes-)
    *   [4.1 Understanding `flake.lock` and Flake Inputs](#41-understanding-flakelock-and-flake-inputs)
    *   [4.2 Minor Updates (within the same NixOS release)](#42-minor-updates-within-the-same-nixos-release)
    *   [4.3 Major Upgrades (to a new NixOS release)](#43-major-upgrades-to-a-new-nixos-release)
    *   [4.4 Managing Other Flake Inputs](#44-managing-other-flake-inputs)
5.  [Conclusion üéâ](#conclusion-)

---

## Part 1: Transitioning to a Full Flake-Managed NixOS System with Home Manager

This section guides you through converting a traditional NixOS setup (or starting fresh) into a system fully managed by Nix Flakes. Flakes offer superior reproducibility, hermetic builds, and better dependency management for your entire NixOS system. We'll also integrate Home Manager at the system level to declaratively manage user environments. This example uses NixOS 25.05 "Warbler".

### 1.1 Prerequisites & Initial Setup

*   **NixOS Installed:** You should have a working NixOS installation (this guide uses 25.05 "Warbler").
*   **Flakes Enabled:** Ensure Flakes are enabled in your Nix configuration. If you're starting from a non-Flake system, you might have this in `/etc/nixos/configuration.nix`:
    ```nix
    # /etc/nixos/configuration.nix (initial state)
    { config, pkgs, ... }: {
      nix.settings.experimental-features = [ "nix-command" "flakes" ];
    }
    ```
*   **Repository Structure:** It's recommended to manage your NixOS Flake configuration in a dedicated Git repository. For this guide, we assume a structure like this (example paths, adjust as needed):
    ```
    ~/Utveckling/nixos-config/  # Your main Flake repository root
    ‚îú‚îÄ‚îÄ flake.nix
    ‚îú‚îÄ‚îÄ flake.lock              # Generated by Nix, commit this!
    ‚îú‚îÄ‚îÄ configuration.nix       # Main system configuration module
    ‚îú‚îÄ‚îÄ hardware-configuration.nix # Hardware-specifics
    ‚îî‚îÄ‚îÄ users/
        ‚îî‚îÄ‚îÄ blfnix.nix          # Home Manager config for user 'blfnix'
    ```
    Your actual NixOS system will be built by pointing `nixos-rebuild` to this Flake directory.

### 1.2 Creating the System `flake.nix`

The `flake.nix` file is the heart of your Flake-managed system. It defines external dependencies (inputs) and what your configuration will produce (outputs).

Place the following content in `~/Utveckling/nixos-config/flake.nix` (adjust path if your repo is elsewhere):

```nix
# ~/Utveckling/nixos-config/flake.nix
{
  description = "My Declarative NixOS System with Flakes and Home Manager";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-25.05"; # NixOS 25.05 Stable

    home-manager = {
      url = "github:nix-community/home-manager/release-25.05"; # HM for NixOS 25.05
      inputs.nixpkgs.follows = "nixpkgs"; # Crucial for consistency
    };
  };

  outputs = { self, nixpkgs, home-manager, ... }@inputs: {
    nixosConfigurations.nixos = nixpkgs.lib.nixosSystem { # Replace 'nixos' if your hostname is different
      system = "x86_64-linux";
      specialArgs = { inherit inputs; }; # Pass inputs to modules
      modules = [
        ./configuration.nix # Main system config
        home-manager.nixosModules.home-manager # HM NixOS module

        # Configure Home Manager globals and define users
        {
          home-manager.useGlobalPkgs = true;
          home-manager.useUserPackages = true;
          home-manager.extraSpecialArgs = { inherit inputs; }; # Pass inputs to home.nix
          home-manager.backupFileExtension = "hm-bak"; # Handle existing dotfiles

          home-manager.users.blfnix = import ./users/blfnix.nix; # Path to user's HM config
          # Add other users:
          # home-manager.users.anotherUser = import ./users/anotherUser.nix;
        }
      ];
    };
  };
}
```
**Key points:**
*   Replace `nixosConfigurations.nixos` with `nixosConfigurations.yourActualHostname` if your machine's hostname (and the desired identifier in the Flake) is different.
*   `inputs.nixpkgs.follows = "nixpkgs";` for `home-manager` is vital for consistency.

### 1.3 Refactoring `configuration.nix` as a Flake Module

Your existing `/etc/nixos/configuration.nix` (which you should copy to `~/Utveckling/nixos-config/configuration.nix`) needs minor adjustments to work as a module within the Flake.

```nix
# ~/Utveckling/nixos-config/configuration.nix
{ config, pkgs, lib, inputs, ... }: # Note `inputs` for Flake context

{
  imports = [ ./hardware-configuration.nix ]; # Assumes hardware-config is in the same directory

  # --- System Settings (Examples, keep your actual config) ---
  boot.loader.systemd-boot.enable = true;
  # boot.initrd.luks.devices... (your LUKS config)

  networking.hostName = "nixos"; # Match the key in nixosConfigurations

  networking.networkmanager.enable = true;
  time.timeZone = "Europe/Stockholm"; # üï∞Ô∏è Customize
  i18n.defaultLocale = "sv_SE.UTF-8"; # üåç Customize
  # i18n.extraLocaleSettings = { ... }; # Your specific settings

  services.xserver.enable = true;
  services.xserver.displayManager.lightdm.enable = true;
  services.xserver.desktopManager.xfce.enable = true;
  # services.xserver.xkb = { ... }; # Your keyboard layout

  security.rtkit.enable = true;
  services.pipewire = {
    enable = true; alsa.enable = true; alsa.support32Bit = true; pulse.enable = true;
  };
  services.pulseaudio.enable = false;

  nix.settings.experimental-features = [ "nix-command" "flakes" ];

  # --- User Accounts ---
  users.users.blfnix = { # Replace 'blfnix' with your username
    shell = pkgs.zsh;
    isNormalUser = true;
    description = "Bengt Frost"; # Your name
    extraGroups = [ "networkmanager" "wheel" ];
    packages = [ ]; # IMPORTANT: User packages now managed by Home Manager
  };

  # --- System-Wide Packages & Settings ---
  environment.systemPackages = with pkgs; [
    wget gitMinimal # Only essential system-wide tools
    # e.g., firefox, libreoffice (if desired for all users)
  ];
  fonts.packages = with pkgs; [ nerd-fonts.cousine ]; # Example font
  programs.gnupg.agent.enable = true;
  services.printing.enable = true;
  services.avahi = { enable = true; nssmdns4 = true; openFirewall = true; };
  nixpkgs.config.allowUnfree = true;

  system.stateVersion = "25.05"; # CRITICAL: Match your NixOS release
}
```
**Key changes:**
*   Ensure the function signature includes `inputs`.
*   **`users.users.blfnix.packages = [ ];` is crucial.**
*   Remove any standalone `home-manager = { ... };` block from here.
*   Prune `environment.systemPackages` to system essentials; user tools go into Home Manager.

### 1.4 Creating the User's Home Manager Configuration (`home.nix`)

Create `~/Utveckling/nixos-config/users/blfnix.nix` (adjust username `blfnix` as needed). This file defines user `blfnix`'s specific environment.

```nix
# ~/Utveckling/nixos-config/users/blfnix.nix
{ pkgs, config, lib, inputs, ... }: # Note `inputs` for Flake context

{
  home.username = "blfnix";
  home.homeDirectory = "/home/blfnix";
  home.stateVersion = "25.05"; # CRITICAL: Match NixOS & HM release

  home.packages = with pkgs; [
    # Dev Toolchains
    rustup python313 uv nodejs_24 zig zls
    # Build Tools (for Zig dev & general C/C++)
    cmake ninja
    llvmPackages_20.clang llvmPackages_20.llvm llvmPackages_20.lld
    llvmPackages_20.bintools llvmPackages_20.clang-tools
    # Editors & LSPs
    helix marksman
    # CLI Tools
    tmux pass keychain git gh fd ripgrep bat jq fzf xclip yazi
    ueberzugpp unar ffmpegthumbnailer poppler_utils w3m zathura swayimg
  ];

  programs.zsh = {
    enable = true;
    autosuggestion.enable = true;
    syntaxHighlighting.enable = true;
    keyMap = "vi"; # Vi keybindings
    shellAliases = {
      ls = "ls --color=auto -F"; ll = "ls -alhF"; la = "ls -AF"; l  = "ls -CF";
      glog = "git log --oneline --graph --decorate --all";
      nix-update-system = "sudo nixos-rebuild switch --flake ~/Utveckling/nixos-config#nixos"; # Adjust path & hostname
      cc = "clang"; cxx = "clang++";
    };
    history = {
      size = 10000; path = "${config.xdg.dataHome}/zsh/history";
      share = true; ignoreDups = true; ignoreSpace = true; save = 10000;
    };
    initContent = ''
      # PATH exports
      export PATH="$HOME/.cargo/bin:$PATH"   # Rust
      export PATH="$HOME/.local/bin:$PATH" # User local installs (like custom Zig)
      export PATH="$HOME/.npm-global/bin:$PATH" # NPM global
      # FZF vars
      export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
      export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
      export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
      # ZLE
      export KEYTIMEOUT=150
      autoload -Uz up-line-or-beginning-search down-line-or-beginning-search
      zle -N up-line-or-beginning-search; zle -N down-line-or-beginning-search
      bindkey "^[[A" up-line-or-beginning-search; bindkey "^[[B" down-line-or-beginning-search
      # Custom Functions (ensure these are defined or remove if not used)
      multipull() { echo "NOTE: Implement your 'multipull' function here or remove this line."; }
      _activate_venv() { echo "NOTE: Implement your '_activate_venv' function here or remove this line."; }
    '';
  };

  programs.starship.enable = true;
  programs.git = {
    enable = true; userName = "Bengt Frost"; userEmail = "bengtfrost@gmail.com"; # Your details!
    extraConfig = { core.editor = "hx"; init.defaultBranch = "main"; };
  };
  programs.helix.enable = true;
  programs.zathura.enable = true;

  home.sessionVariables = {
    EDITOR = "hx"; VISUAL = "hx"; PAGER = "less";
    CC = "clang"; CXX = "clang++"; GIT_TERMINAL_PROMPT = "1";
  };
}
```
**Key points for `home.nix`:**
*   Populate `home.packages` with all tools `blfnix` needs.
*   Configure Zsh, Git, Helix, Starship, etc., using their Home Manager modules.
*   Use `initContent` for Zsh `PATH` exports, functions, and specific `setopt`/`bindkey` commands.
*   Don't forget to set your correct Git `userName` and `userEmail`.
*   Ensure your actual `multipull` and `_activate_venv` functions are defined in `initContent`.

### 1.5 The First System Build with Flakes & Home Manager

With `flake.nix`, `configuration.nix`, and your user's `home.nix` in place within your Flake repository (e.g., `~/Utveckling/nixos-config/`):

1.  **Navigate to your Flake directory:**
    ```bash
    cd ~/Utveckling/nixos-config
    ```
2.  **Build and switch to the new configuration:**
    ```bash
    sudo nixos-rebuild switch --flake .#nixos
    # Replace 'nixos' with your system's actual name in flake.nix outputs
    ```
    This command might take some time on the first run.
3.  **Troubleshooting (Recap):**
    *   **Purity Errors:** Ensure `home.nix` is imported with a relative path (e.g., `import ./users/blfnix.nix;`) from `flake.nix`.
    *   **Home Manager Activation Conflicts:** `home-manager.backupFileExtension = "hm-bak";` in `flake.nix` handles this.
    *   **Incorrect Module Options:** Refer to Home Manager documentation for current option names (e.g., Zsh `autosuggestion.enable`, `keyMap = "vi"` or `bindkey -v`).
    *   **Package Collisions:** Ensure only one package provides a given binary (e.g., use `pkgs.git` not `gitFull` if conflicts arise; remove `llvmPackages_XX.bintools` if `clang` handles `objdump`).
    *   **`stateVersion`:** Match `system.stateVersion` and `home.stateVersion` to your NixOS release (e.g., `"25.05"`).
4.  **Post-Build Steps:**
    *   **Log out and log back in** as your user (`blfnix`) for all Home Manager settings to take effect.
    *   **Initialize `rustup` (as user `blfnix`):**
        ```bash
        rustup default stable
        rustup component add rust-src clippy rustfmt
        ```

---

## Part 2: Customizing and Managing Your User Environment with Home Manager

This section details how to use and extend your Home Manager configuration (`~/Utveckling/nixos-config/users/blfnix.nix`) for ongoing management of your user environment. Remember to run `sudo nixos-rebuild switch --flake ~/Utveckling/nixos-config#nixos` (from your Flake root) after making changes.

### 2.1 Adding and Removing User Packages (`home.packages`)
The `home.packages` list is your personal software inventory.

*   **To add a package:** Find it on [search.nixos.org](https://search.nixos.org) and add `pkgs.<packagename>` to the list.
    ```nix
    # ~/Utveckling/nixos-config/users/blfnix.nix
    home.packages = with pkgs; [
      # ... existing packages ...
      neofetch # System information tool
      htop     # Interactive process viewer
    ];
    ```
*   **To remove:** Delete the line from the list.

### 2.2 Advanced Shell Configuration (Zsh Example)
All Zsh settings for `blfnix` are within `programs.zsh = { ... };`.

*   **Aliases (`shellAliases`):**
    ```nix
    programs.zsh.shellAliases = {
      # ... existing ...
      k = "kubectl";
      cat = "bat --paging=never"; # Always use bat
    };
    ```
*   **Environment Variables:**
    *   Global: Use `home.sessionVariables` (see `blfnix.nix` above).
    *   Zsh-Specific/Dynamic: Add `export` lines to `programs.zsh.initContent`.
*   **Functions, Zsh Options, Keybindings:** Add to `programs.zsh.initContent`. For example, to add `setopt extended_glob`:
    ```nix
    programs.zsh.initContent = ''
      # ... existing content ...
      setopt extended_glob
      # Your multipull and _activate_venv functions go here (ensure they are fully defined)
    '';
    ```

### 2.3 Managing Application Settings (`programs.appname`)
Home Manager modules allow declarative app configuration.

*   **Starship (`programs.starship`):**
    ```nix
    programs.starship = {
      enable = true;
      # To use a custom starship.toml:
      # 1. Create `~/Utveckling/nixos-config/dotfiles/starship.toml`
      # 2. Add to programs.starship:
      #    settings = builtins.fromTOML (builtins.readFile ../dotfiles/starship.toml);
    };
    ```
*   **Helix (`programs.helix` and `xdg.configFile`):**
    ```nix
    programs.helix.enable = true; # Installs Helix

    # To manage Helix config files:
    # 1. Create your Helix config files, e.g.:
    #    ~/Utveckling/nixos-config/dotfiles/helix/config.toml
    #    ~/Utveckling/nixos-config/dotfiles/helix/languages.toml
    # 2. Add to your blfnix.nix:
    # xdg.configFile."helix/config.toml".source = ../dotfiles/helix/config.toml;
    # xdg.configFile."helix/languages.toml".source = ../dotfiles/helix/languages.toml;
    ```
    *(Note: The `../dotfiles/` path assumes `blfnix.nix` is in `users/` and `dotfiles/` is at the Flake root `~/Utveckling/nixos-config/dotfiles/`)*

### 2.4 Managing Dotfiles (`home.file` or `xdg.configFile`)
*   **`home.file.".filename"`:** For files directly in `~`.
    ```nix
    # home.file.".my_cool_script.sh" = {
    #   source = ../dotfiles/my_cool_script.sh; # Assumes script is in dotfiles/
    #   executable = true;
    # };
    ```
*   **`xdg.configFile."app/config"`:** For files in `~/.config/`. (Used for Helix above).

---

## Part 3: Building a Custom Zig Development Version ‚ö°

This section details compiling Zig `0.15.0-dev.669+561ab59ce` from source.

### 3.1 Prerequisites
Ensure `cmake`, `ninja`, and `llvmPackages_20.clang` (and its companions) are in your `home.packages`.

### 3.2 The Build Script (`build-zig-dev.sh`)
Save the following as `build-zig-dev.sh` (e.g., in `~/Utveckling/nixos-config/scripts/build-zig-dev.sh` or a temporary build directory). This script targets Zig `0.15.0-dev.669+561ab59ce`.

```bash
#!/usr/bin/env bash
set -euo pipefail

# --- Configuration ---
ZIG_VERSION_TO_BUILD="0.15.0-dev.669+561ab59ce"
DOWNLOAD_DIR="${PWD}" # Assumes tarballs are in CWD

STAGE1_TARBALL_NAME="zig-x86_64-linux-${ZIG_VERSION_TO_BUILD}.tar.xz"
SOURCE_TARBALL_NAME="zig-${ZIG_VERSION_TO_BUILD}.tar.xz" # From your ls output; verify if Zig changes to -src-

BASE_DEV_DIR="${HOME}/Utveckling/Zig"
STAGE1_EXTRACTION_DIR="${BASE_DEV_DIR}/zig_compilers/zig-${ZIG_VERSION_TO_BUILD}"
STAGE1_ZIG_COMPILER_PATH="${STAGE1_EXTRACTION_DIR}/zig"
SOURCE_EXTRACTION_DIR="${BASE_DEV_DIR}/zig_source/zig-${ZIG_VERSION_TO_BUILD}"
FINAL_INSTALL_PREFIX="${HOME}/.local/zig-${ZIG_VERSION_TO_BUILD}"
FINAL_SYMLINK_NAME="zig-${ZIG_VERSION_TO_BUILD}"
FINAL_SYMLINK_PATH="${HOME}/.local/bin/${FINAL_SYMLINK_NAME}"

# --- Args ---
REBUILD_ARTIFACTS=false; CHECK_AFTER_BUILD=false; OPTIMIZE_LEVEL="ReleaseFast"; ADDITIONAL_ZIG_BUILD_OPTIONS=()
while [[ $# -gt 0 ]]; do case "$1" in --check) CHECK_AFTER_BUILD=true;; --rebuild-artifacts) REBUILD_ARTIFACTS=true;; --optimize=*) OPTIMIZE_LEVEL="${1#*=}";; -D*) ADDITIONAL_ZIG_BUILD_OPTIONS+=("$1");; *) echo "‚ùå Unk opt: $1";exit 1;; esac; shift; done

# --- Prep ---
echo "‚û°Ô∏è Preparing Zig build for version: ${ZIG_VERSION_TO_BUILD}"
echo "   Stage1 Tarball:      ${DOWNLOAD_DIR}/${STAGE1_TARBALL_NAME}"
echo "   Source Tarball:      ${DOWNLOAD_DIR}/${SOURCE_TARBALL_NAME}"
# ... (other echos for paths are good for script verbosity) ...
if [ ! -f "${DOWNLOAD_DIR}/${STAGE1_TARBALL_NAME}" ]; then echo "‚ùå Stage1 tarball not found: ${DOWNLOAD_DIR}/${STAGE1_TARBALL_NAME}"; exit 1; fi
if [ ! -f "${DOWNLOAD_DIR}/${SOURCE_TARBALL_NAME}" ]; then echo "‚ùå Source tarball not found: ${DOWNLOAD_DIR}/${SOURCE_TARBALL_NAME}"; exit 1; fi
if [ "$REBUILD_ARTIFACTS" = true ]; then echo "üóëÔ∏è Cleaning previous build artifacts..."; rm -rf "$STAGE1_EXTRACTION_DIR" "$SOURCE_EXTRACTION_DIR" "$FINAL_INSTALL_PREFIX"; fi
mkdir -p "$STAGE1_EXTRACTION_DIR" "$SOURCE_EXTRACTION_DIR" "$FINAL_INSTALL_PREFIX" "$(dirname "$FINAL_SYMLINK_PATH")"

# --- Extract Stage1 ---
if [ ! -f "$STAGE1_ZIG_COMPILER_PATH" ] || [ "$REBUILD_ARTIFACTS" = true ]; then
  echo "üì¶ Extracting Stage1 compiler..."; tar -xf "${DOWNLOAD_DIR}/${STAGE1_TARBALL_NAME}" -C "$STAGE1_EXTRACTION_DIR" --strip-components=1 || { echo "‚ùå Failed Stage1 extraction"; exit 1; }
  echo "‚úÖ Stage1 extracted."
fi
if [ ! -x "$STAGE1_ZIG_COMPILER_PATH" ]; then echo "‚ùå Stage1 zig not found or not executable: $STAGE1_ZIG_COMPILER_PATH"; exit 1; fi
echo "‚ÑπÔ∏è Using Stage1 Zig ($($STAGE1_ZIG_COMPILER_PATH version)) from: $STAGE1_ZIG_COMPILER_PATH"

# --- Extract Source ---
if [ ! -f "${SOURCE_EXTRACTION_DIR}/build.zig" ] || [ "$REBUILD_ARTIFACTS" = true ]; then
  echo "üì¶ Extracting Zig source code..."; if [ "$REBUILD_ARTIFACTS" = true ] && [ -d "$SOURCE_EXTRACTION_DIR" ]; then rm -rf "${SOURCE_EXTRACTION_DIR:?}"/*; fi
  tar -xf "${DOWNLOAD_DIR}/${SOURCE_TARBALL_NAME}" -C "$SOURCE_EXTRACTION_DIR" --strip-components=1 || { echo "‚ùå Failed Source extraction"; exit 1; }
  echo "‚úÖ Zig source extracted."
fi
if [ ! -f "${SOURCE_EXTRACTION_DIR}/build.zig" ]; then echo "‚ùå Target source 'build.zig' not found in: ${SOURCE_EXTRACTION_DIR}"; exit 1; fi

# --- Build Process ---
cd "$SOURCE_EXTRACTION_DIR"
if [ "$REBUILD_ARTIFACTS" = true ]; then echo "üóëÔ∏è Cleaning local build cache (zig-cache, zig-out)..."; rm -rf ./zig-cache ./zig-out; fi
echo "üèó Building Zig ${ZIG_VERSION_TO_BUILD}...";
if [ "$REBUILD_ARTIFACTS" != true ]; then echo "üßº Cleaning previous build from install destination: ${FINAL_INSTALL_PREFIX}"; rm -rf "${FINAL_INSTALL_PREFIX:?}"/*; fi
BUILD_ARGS=(build install -p "$FINAL_INSTALL_PREFIX" "-Doptimize=${OPTIMIZE_LEVEL}" "-Dtarget=native" -Dstrip "${ADDITIONAL_ZIG_BUILD_OPTIONS[@]}")
echo "üöÄ Executing: $STAGE1_ZIG_COMPILER_PATH ${BUILD_ARGS[*]}"
"$STAGE1_ZIG_COMPILER_PATH" "${BUILD_ARGS[@]}" || { echo "‚ùå Zig build failed!"; exit 1; }

# --- Post-Build ---
REBUILT_ZIG_BIN="${FINAL_INSTALL_PREFIX}/bin/zig"
if [ ! -x "$REBUILT_ZIG_BIN" ]; then echo "‚ùå Zig binary not found after build at: $REBUILT_ZIG_BIN"; exit 1; fi
if [ "$CHECK_AFTER_BUILD" = true ]; then echo "üîç Checking newly built Zig version:"; "$REBUILT_ZIG_BIN" version; fi
echo "üîó Creating symlink: $FINAL_SYMLINK_PATH -> ${REBUILT_ZIG_BIN}"; ln -sf "$REBUILT_ZIG_BIN" "$FINAL_SYMLINK_PATH"
echo "‚úÖ Zig ${ZIG_VERSION_TO_BUILD} successfully built and installed."
echo "   Version reported by new binary: $($REBUILT_ZIG_BIN version)"
echo "   Installed to: $FINAL_INSTALL_PREFIX"
echo "   Symlink available at: $FINAL_SYMLINK_PATH"
echo "üîî To make this your default 'zig' command, run: ln -sf \"$REBUILT_ZIG_BIN\" \"${HOME}/.local/bin/zig\""
```

### 3.3 Running the Build Script with `nix-shell`
Create a temporary directory, download the Zig tarballs (Stage1 binary for x86_64-linux and the source tarball for version `0.15.0-dev.669+561ab59ce`), and place your `build-zig-dev.sh` script there.

Then, from that directory, run:
```bash
nix-shell -p pkgs.stdenv pkgs.bash \
  pkgs.llvmPackages_20.clang pkgs.llvmPackages_20.bintools \
  pkgs.cmake pkgs.ninja \
  --run "./build-zig-dev.sh"
```
**Why `nix-shell`?** The `nix-shell` creates an isolated environment:
*   It ensures the generic Linux Stage1 Zig binary can run correctly on NixOS by providing a compatible dynamic linker and standard C libraries from `pkgs.stdenv`.
*   It makes the specified versions of Clang, CMake, Ninja, and other build tools available in the `PATH` for the script.

### 3.4 Post-Build: Using Your Custom Zig
*   Installed to: `~/.local/zig-0.15.0-dev.669+561ab59ce/`
*   Symlink: `~/.local/bin/zig-0.15.0-dev.669+561ab59ce`
*   Since `~/.local/bin` is in your `PATH` (from `programs.zsh.initContent`), run with:
    `zig-0.15.0-dev.669+561ab59ce version`
*   The `zig` command will still point to your system's stable Zig. To make the dev version default, run:
    `ln -sf ~/.local/zig-0.15.0-dev.669+561ab59ce/bin/zig ~/.local/bin/zig`

---

## Part 4: System and Package Updates with Flakes üîÑ

With Flakes, updates are explicit and controlled.

### 4.1 Understanding `flake.lock`
Your `flake.lock` file (e.g., in `~/Utveckling/nixos-config/flake.lock`) pins the exact commits of your inputs (`nixpkgs`, `home-manager`). `nixos-rebuild` always uses these locked versions.

### 4.2 Minor Updates (Patches for NixOS 25.05)
1.  **Update Lock File:** Fetches latest commits on the `nixos-25.05` (and `release-25.05` for HM) branches.
    ```bash
    cd ~/Utveckling/nixos-config # Your Flake directory
    sudo nix flake update
    ```
2.  **Rebuild System:** Applies these newer packages.
    ```bash
    sudo nixos-rebuild switch --flake .#nixos # Or your system name
    ```

### 4.3 Major Upgrades (e.g., to NixOS 25.11)
1.  **Read Release Notes!** Crucial for breaking changes.
2.  **Edit `flake.nix`:** Update `inputs` URLs:
    ```nix
    # Example for a hypothetical NixOS 25.11
    inputs = {
      nixpkgs.url = "github:NixOS/nixpkgs/nixos-25.11"; # Target new release
      home-manager.url = "github:nix-community/home-manager/release-25.11";
      # ...
    };
    ```
3.  **Update Lock File:**
    ```bash
    sudo nix flake update
    ```
4.  **First Rebuild:** Builds system with new NixOS version.
    ```bash
    sudo nixos-rebuild switch --flake .#nixos
    ```
5.  **Update `stateVersion`:**
    *   In `configuration.nix`: `system.stateVersion = "25.11";` (use the new version string)
    *   In `users/blfnix.nix`: `home.stateVersion = "25.11";` (use the new version string)
6.  **Second Rebuild:** Applies state version changes.
    ```bash
    sudo nixos-rebuild switch --flake .#nixos
    ```
7.  **Test thoroughly.** Roll back if needed via bootloader.

### 4.4 Managing Other Flake Inputs
If you add more Flake inputs, update them with `sudo nix flake update <input-name>` or all with `sudo nix flake update`.

---

## Conclusion üéâ

You've successfully configured a NixOS system fully managed by Flakes, with your user environment declaratively controlled by Home Manager. This setup offers exceptional reproducibility and control.

**Key Takeaways:**
*   **Declarative Power:** System & user environments defined as code.
*   **Reproducibility:** Flakes + `flake.lock` ensure consistent builds.
*   **Home Manager:** Clean, modular user environment management.
*   **Controlled Updates:** Explicit control over system and package versions.
*   **Isolated Custom Builds:** `nix-shell` for complex tasks like compiling Zig.

This foundation empowers you to refine your NixOS system with confidence. Happy Nixin'!
